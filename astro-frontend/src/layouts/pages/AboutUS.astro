---
import InternalPageLayout from '@/layouts/shared/InternalPageLayout.astro'
import AboutSlider from '@/components/shared/AboutSlider.astro'
import Clients from '@/components/shared/Clients.astro'
import { fetchAboutUsPageByLocale } from '@/lib/sanity/queries/aboutUsPageQueries'
import { fetchFeaturedClients } from '@/lib/sanity/queries/clientQueries'
import type { AboutUsPage } from '@/lib/sanity/schemas/aboutUsPageSchema'
import { getPageMetadata } from '@/config/i18n/pageMetadata'
import { portableTextToHtml } from '@/lib/sanity/utils/portableTextToHtml'
import type { DisplayImage } from '@/components/shared/AboutSlider.astro'

const { locale } = Astro.props

console.log('🌐 [About Us Layout] Locale:', locale)

let aboutUsPageData: AboutUsPage | null = null
let clients = []

try {
  // Fetch both in parallel for better performance
  ;[aboutUsPageData, clients] = await Promise.all([
    fetchAboutUsPageByLocale(locale),
    fetchFeaturedClients(),
  ])
  console.log('📄 [About Us Layout] About Us Page Data:', aboutUsPageData)
  console.log('📄 [About Us Layout] Page Title:', aboutUsPageData?.title)
  console.log('📄 [About Us Layout] Description (raw):', aboutUsPageData?.description)
  console.log('📄 [About Us Layout] About Slider:', aboutUsPageData?.aboutSlider)
  console.log('📄 [About Us Layout] Slider Title:', aboutUsPageData?.aboutSlider?.title)
  console.log(
    '📄 [About Us Layout] Slider Images:',
    aboutUsPageData?.aboutSlider?.images?.length || 0,
  )
  console.log('📄 [About Us Layout] Clients Title:', aboutUsPageData?.clientsTitle)
  console.log('📄 [About Us Layout] Clients Data:', clients)
  console.log('📄 [About Us Layout] Number of clients:', clients?.length || 0)
} catch (error) {
  console.error('❌ [About Us Layout] Error fetching about us page data:', error)
}

const metadata = getPageMetadata('about', locale)

// Convert portable text description to HTML
const descriptionHtml = aboutUsPageData?.description
  ? portableTextToHtml(aboutUsPageData.description)
  : null

// Transform images to the expected format for AboutSlider
const sliderImages: DisplayImage[] = aboutUsPageData?.aboutSlider?.images
  ? aboutUsPageData.aboutSlider.images.map((img) => ({
      ...img,
      asset: img.asset,
    }))
  : []

console.log('📋 [About Us Layout] Description HTML:', descriptionHtml)
---

<InternalPageLayout
  pageMetaTitle={metadata.title}
  pageMetaDescription={metadata.description}
  pageTitle={aboutUsPageData?.title || 'About Us'}
  pageDescription={descriptionHtml}
>
  {
    aboutUsPageData?.aboutSlider && (
      <div class="g-negative-inline-padding">
        <AboutSlider
          title={aboutUsPageData.aboutSlider.title}
          description={aboutUsPageData.aboutSlider.description}
          images={sliderImages}
        />
      </div>
    )
  }

  {
    aboutUsPageData?.clientsTitle && (
      <Clients
        clientsData={{ title: aboutUsPageData.clientsTitle }}
        paddingBlockStart="var(--padding-block)"
        paddingBlockEnd="0"
        paddingInline="0"
        clients={clients}
      />
    )
  }
</InternalPageLayout>
