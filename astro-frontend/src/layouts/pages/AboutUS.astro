---
import InternalPageLayout from '@/layouts/shared/InternalPageLayout.astro'
import AboutSlider from '@/components/shared/AboutSlider.astro'
import Clients from '@/components/shared/Clients.astro'
import { fetchAboutUsPageByLocale } from '@/lib/sanity/queries/aboutUsPageQueries'
import { fetchFeaturedClients } from '@/lib/sanity/queries/clientQueries'
import type { AboutUsPage } from '@/lib/sanity/schemas/aboutUsPageSchema'
import { portableTextToHtmlForPageSection } from '@/lib/sanity/utils/portableTextToHtml'
import type { DisplayImage } from '@/components/shared/AboutSlider.astro'

const { locale } = Astro.props

let aboutUsPageData: AboutUsPage | null = null
let clients = []

try {
  // Fetch both in parallel for better performance
  ;[aboutUsPageData, clients] = await Promise.all([
    fetchAboutUsPageByLocale(locale),
    fetchFeaturedClients(),
  ])
  console.log('About Us Page Data:', aboutUsPageData)
  console.log('Clients Title:', aboutUsPageData?.clientsTitle)
} catch (error) {
  console.error('Error fetching about us page data:', error)
}

const descriptionHtml = portableTextToHtmlForPageSection(aboutUsPageData?.description)

// Transform images to the expected format for AboutSlider
const sliderImages: DisplayImage[] = aboutUsPageData?.aboutSlider?.images
  ? aboutUsPageData.aboutSlider.images.map((img) => ({
      ...img,
      asset: img.asset,
    }))
  : []
---

<InternalPageLayout
  pageMetaTitle={aboutUsPageData?.title || 'About Us'}
  pageMetaDescription={descriptionHtml}
  pageTitle={aboutUsPageData?.title || 'About Us'}
>
  {
    aboutUsPageData?.aboutSlider && (
      <div class="g-negative-inline-padding">
        <AboutSlider
          title={aboutUsPageData.aboutSlider.title}
          description={aboutUsPageData.aboutSlider.description}
          images={sliderImages}
        />
      </div>
    )
  }

  {
    aboutUsPageData?.clientsTitle && (
      <Clients
        clientsData={{ title: aboutUsPageData.clientsTitle }}
        paddingBlockStart="var(--padding-block)"
        paddingBlockEnd="0"
        paddingInline="0"
        clients={clients}
      />
    )
  }
</InternalPageLayout>
