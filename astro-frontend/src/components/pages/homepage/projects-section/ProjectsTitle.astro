---
interface Props {
  title: string
}

const { title } = Astro.props

/**
 * Parse title with **highlighted** syntax.
 * Returns an array of segments: { text: string, highlighted: boolean }
 * Example: "Hello **world**!" -> [{ text: "Hello ", highlighted: false }, { text: "world", highlighted: true }, { text: "!", highlighted: false }]
 */
function parseHighlightedTitle(raw: string): Array<{ text: string; highlighted: boolean }> {
  const segments: Array<{ text: string; highlighted: boolean }> = []
  const regex = /\*\*([^*]+)\*\*/g
  let lastIndex = 0
  let match

  while ((match = regex.exec(raw)) !== null) {
    // Add text before the match (if any)
    if (match.index > lastIndex) {
      segments.push({ text: raw.slice(lastIndex, match.index), highlighted: false })
    }
    // Add the highlighted text (without the **)
    segments.push({ text: match[1], highlighted: true })
    lastIndex = regex.lastIndex
  }

  // Add remaining text after last match (if any)
  if (lastIndex < raw.length) {
    segments.push({ text: raw.slice(lastIndex), highlighted: false })
  }

  // If no segments were created (no ** found), return the whole title as non-highlighted
  if (segments.length === 0) {
    segments.push({ text: raw, highlighted: false })
  }

  return segments
}

const segments = parseHighlightedTitle(title)
// Plain text version for screen readers (without the **)
const plainTitle = title.replace(/\*\*([^*]+)\*\*/g, '$1')
---

<h2 id="projects-heading" class="hero-big-text projects-heading">
  {
    segments.map((segment) =>
      segment.highlighted ? (
        <span class="highlighted-word">
          {segment.text}
          <div class="highlight-underline">
            <svg
              width="100%"
              height="100%"
              viewBox="0 0 120 8"
              xmlns="http://www.w3.org/2000/svg"
              class="highlight-svg"
              preserveAspectRatio="none"
            >
              <path
                class="highlight-path"
                d="M118.044 3.70327C103.584 1.84112 89.0612 0.68815 74.5157 0.263129C59.9721 -0.161867 45.4117 0.136598 30.8825 1.15457C23.9959 1.63755 17.1188 2.28731 10.2531 3.09245L10.2533 3.08332C8.51527 3.24381 6.75534 3.46565 5.03074 3.78155C4.26961 3.92024 1.57329 4.30594 1.16902 4.95369C0.768678 5.59465 0.995679 6.48787 1.62693 6.73562C2.0382 6.89609 3.80961 7.13097 4.24439 7.10683C4.66379 7.0825 4.90003 6.79786 4.92379 6.29136C4.93703 6.00617 4.68599 5.64228 5.01245 5.51859L8.97367 4.98692C22.5534 3.35417 36.1828 2.34756 49.8252 1.98033C64.3714 1.58809 78.9316 1.9197 93.4498 2.97216C101.657 3.56755 109.849 4.3956 118.022 5.4494C118.962 5.57096 118.978 3.82248 118.044 3.70099L118.044 3.70327Z"
              />
            </svg>
          </div>
        </span>
      ) : (
        <span>{segment.text}</span>
      ),
    )
  }

  <!-- Screen-reader full sentence (without ** markers) -->
  <span class="sr-only">{plainTitle}</span>
</h2>

<style>
  h2 {
    grid-column: 55 / span 59;
    grid-row: 15 / span 10;
    padding-inline-start: 0.3125rem;
  }

  .hero-big-text {
    font-size: clamp(3.375rem, 0.281rem + 4.99vi, 5rem);
  }

  .projects-heading {
    display: block;
    white-space: pre-wrap; /* Preserve spaces */
  }

  .highlighted-word {
    position: relative;
    display: inline-block;
    white-space: normal;
  }

  .highlight-underline {
    position: absolute;
    inset-block-end: -0.6rem;
    inset-inline-start: 0;
    width: 100%;
    height: 1.2rem;
    z-index: 1;
    pointer-events: none;
  }

  .highlight-svg {
    display: block;
    width: 100%;
    height: 100%;
  }

  .highlight-path {
    fill: var(--color-secondary);
    transform-origin: left center;
  }

  @media (prefers-reduced-motion: reduce) {
    .highlight-underline {
      opacity: 1;
    }
  }
</style>
