---
import HighlightScribble from '@/assets/HighlightScribble.astro'
import ScrollPill from '@/assets/ScrollPill.astro'
import {
  splitBoldSegments,
  splitBoldSegmentsByLine,
} from '@/utils/pages/homepage/parseBoldMarkdown'
import type { HomePage } from '@/shared/schemas/sanity/homePageSchema'

interface Props {
  heroData: HomePage['hero'] | Record<string, never> // HomePage['hero'] is SanityHeroSectionType | null
}

const { heroData } = Astro.props

// Check if the text contains line breaks
const hasLineBreaks = heroData?.heroText?.includes('\n')

// Use the appropriate parsing function
const parsedText = hasLineBreaks ? splitBoldSegmentsByLine(heroData?.heroText) : null

// Fall back to the original parsing for backward compatibility
const {
  before: beforeHighlight,
  bold: highlightedWord,
  after: afterHighlight,
} = !hasLineBreaks ? splitBoldSegments(heroData?.heroText) : { before: '', bold: '', after: '' }

const scrollText = heroData?.scrollText

// Get text alignment from Sanity, default to 'left' for backward compatibility
const textAlignment = heroData?.textAlignment || 'left'
const mobileTextAlignment = heroData?.mobileTextAlignment || 'center'

// Determine scroll indicator position class based on desktop alignment
const scrollPositionClass =
  textAlignment === 'center'
    ? 'bottom-center'
    : textAlignment === 'right'
      ? 'bottom-right'
      : 'bottom-left'
---

<script src="@/scripts/pages/homepage/heroScroll.ts"></script>
<script src="@/scripts/animations/slideUpTextAnimation.ts"></script>

<div class={`hero-wrapper ${textAlignment}-aligned mobile-${mobileTextAlignment}-aligned`}>
  <h1 data-slide-up-animation data-animate-immediate class="hero-title">
    {
      hasLineBreaks && parsedText ? (
        parsedText.lines.map((line, index) => (
          <>
            {line.before}
            {line.bold && (
              <span class="highlight-wrapper">
                <span class="highlight-text">{line.bold}</span>
                <HighlightScribble top="9.8rem" animationDelay="1.5s" />
              </span>
            )}
            {line.after}
            {index < parsedText.lines.length - 1 && <br />}
          </>
        ))
      ) : (
        <>
          {beforeHighlight}
          {highlightedWord && (
            <span class="highlight-wrapper">
              <span class="highlight-text">{highlightedWord}</span>
              <HighlightScribble top="9.8rem" animationDelay="1.5s" />
            </span>
          )}
          {afterHighlight}
        </>
      )
    }
  </h1>
  <button class={`scroll-indicator ${scrollPositionClass} just-desktop`}>
    <ScrollPill />

    <p class="label-wrapper">
      <span class="label-main">{scrollText}</span>
      <span aria-hidden="true" class="label-hover">{scrollText}</span>
    </p>
  </button>
</div>

<style is:global>
  /* Hide animation elements initially to prevent FOUC */
  [data-slide-up-animation]:not([data-animation-complete]) {
    visibility: hidden;
  }

  /* Slide-up text animation styles - global to work with dynamically created elements */
  [data-animation='pending'] {
    visibility: hidden;
  }

  [data-animation='ready'],
  [data-animation='active'],
  [data-animation-complete] {
    visibility: visible;
  }

  /* Line animation styles */
  .slide-up-line {
    display: block !important;
    overflow: hidden !important;
    position: relative !important;
    margin-bottom: -0.14em !important;
  }

  .slide-up-line-inner {
    display: inline-block !important;
    transform: translate3d(
      0,
      105%,
      0
    ) !important; /* Slightly more than 100% to ensure full hiding */
    will-change: transform !important;
    padding-bottom: 0.2em !important; /* Space for descenders on the inner element */
  }

  /* Animation triggered state with CSS variables for customization */
  [data-animation='active'] .slide-up-line-inner,
  [data-animation-complete] .slide-up-line-inner {
    transform: translate3d(0, 0, 0) !important;
    transition: transform var(--animation-duration, 1.5s)
      var(--animation-easing, cubic-bezier(0.19, 1, 0.22, 1)) !important;
    transition-delay: var(--animation-delay, 750ms) !important;
  }

  /* Ensure special elements maintain proper sizing within animated lines */
  .slide-up-line .highlight-wrapper,
  .slide-up-line strong,
  .slide-up-line em,
  .slide-up-line a {
    display: inline !important;
    position: relative !important;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .slide-up-line-inner {
      transform: translate3d(0, 0, 0) !important;
      transition: none !important;
    }
  }
</style>

<style>
  /* Wrapper to maintain consistent layout */
  .hero-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }

  /* Desktop alignment variations */
  .hero-wrapper.left-aligned {
    align-items: flex-start;
  }

  .hero-wrapper.center-aligned {
    align-items: center;
  }

  .hero-wrapper.right-aligned {
    align-items: flex-end;
  }

  /* Text alignment for desktop */
  .hero-wrapper.left-aligned .hero-title {
    text-align: left;
  }

  .hero-wrapper.center-aligned .hero-title {
    text-align: center;
  }

  .hero-wrapper.right-aligned .hero-title {
    text-align: right;
  }

  h1 {
    font-size: clamp(3rem, 1.047rem + 8.014vi, 8.625rem);
    letter-spacing: -0.04em;
    font-weight: var(--font-weight-semibold);
    line-height: 1.03;
    padding-block-end: 3rem;
    gap: 0.4em;

    .highlight-text {
      position: relative;
      z-index: 2;
    }

    &:hover .highlight-svg {
      scale: 1.05;
    }
  }

  .highlight-wrapper {
    position: relative;
    display: inline-block;
  }

  .scroll-indicator {
    display: flex;
    align-items: center;
    gap: 1.375rem;

    &:hover .label-main,
    &:focus-within .label-main {
      transform: translateY(-100%);
    }

    &:hover .label-hover,
    &:focus-within .label-hover {
      transform: translateY(0);
    }
  }

  @media (width < 1025px) {
    h1 {
      width: 100%;
      padding-block: 7.625rem;
    }
    .scroll-indicator {
      display: none;
    }

    /* Mobile alignment variations */
    .hero-wrapper.mobile-left-aligned {
      align-items: flex-start;
    }

    .hero-wrapper.mobile-center-aligned {
      align-items: center;
    }

    .hero-wrapper.mobile-right-aligned {
      align-items: flex-end;
    }

    /* Override desktop text alignment on mobile */
    .hero-wrapper.mobile-left-aligned .hero-title {
      text-align: left !important;
    }

    .hero-wrapper.mobile-center-aligned .hero-title {
      text-align: center !important;
    }

    .hero-wrapper.mobile-right-aligned .hero-title {
      text-align: right !important;
    }
  }

  @media (width < 390px) {
    h1 {
      font-size: clamp(2.75rem, -0.25rem + 13.333vi, 3rem);
    }
  }
</style>
