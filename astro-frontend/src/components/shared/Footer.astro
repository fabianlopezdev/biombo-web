---
import HighlightScribble from '@/assets/HighlightScribble.astro'
import WhiteUpArrow from '@/assets/white-up-arrow.svg?raw'
import { fetchFooter } from '@/shared/lib/sanity/queries/footerQueries'

const currentYear = new Date().getFullYear()
const locale = (Astro.currentLocale as 'ca' | 'es' | 'en') || 'ca'

// Fetch footer data from Sanity
const footerData = await fetchFooter(locale)

// Fallback values if no data from Sanity
const slogan = footerData?.slogan || 'Transformem\nidees junts. **Parlem?**'
const backToTopText = footerData?.backToTopText || "Tornar a l'inici"
const email = footerData?.email || 'info@biombostudio.com'
const phone = footerData?.phone || '+(34) 696 157 318'
const socialLinks = footerData?.socialLinks || [
  { platform: 'Instagram', url: 'https://www.instagram.com/biombostudio/' },
  { platform: 'LinkedIn', url: 'https://www.linkedin.com/in/biomb%C3%B6-studio-13090b99/' },
]
const legalLinkText = footerData?.legalLinkText || 'Avís Legal'
const legalLinkUrl = footerData?.legalLinkUrl || '/avis-legal'

// Parse slogan to handle **bold** text
const parsedSlogan = slogan.split('**').map((part, index) => ({
  text: part,
  isBold: index % 2 === 1,
}))
---

<script src="@/scripts/animateOnRevealObserver.ts"></script>

<footer class="picket-fence">
  <div class="footer-first-row">
    <h2 class="footer-slogan">
      {
        parsedSlogan.map((part) => {
          // Handle line breaks in the text
          const lines = part.text.split('\n')
          return lines.map((line, lineIndex) => (
            <>
              {lineIndex > 0 && <br />}
              {part.isBold ? (
                <span class="highlight-wrapper">
                  <span class="highlight-text">{line}</span>
                  <HighlightScribble
                    color="var(--color-primary)"
                    top="clamp(3.188rem, 2.558rem + 2.582vi, 5rem)"
                    animateOnReveal={true}
                  />
                </span>
              ) : (
                line
              )}
            </>
          ))
        })
      }
    </h2>
    <a href="#top" class="back-to-top-link desktop-only">
      {backToTopText}
      <div class="arrow-up">
        <Fragment set:html={WhiteUpArrow} />
      </div>
    </a>
  </div>

  <div class="footer-second-row">
    <div class="contact-info">
      <address>
        <a href={`mailto:${email}`}>
          <div class="label-wrapper">
            <span class="label-main">{email}</span>
            <span aria-hidden="true" class="label-hover">{email}</span>
          </div>
        </a>
        <a href={`tel:${phone.replace(/[^\d+]/g, '')}`}>
          <div class="label-wrapper">
            <span class="label-main">{phone}</span>
            <span aria-hidden="true" class="label-hover">{phone}</span>
          </div>
        </a>
      </address>
      <ul class="social-links">
        {
          socialLinks.map((link) => (
            <li>
              <a href={link.url} target="_blank" rel="noopener noreferrer">
                <div class="label-wrapper">
                  <span class="label-main">{link.platform}</span>
                  <span aria-hidden="true" class="label-hover">
                    {link.platform}
                  </span>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    <a href="#top" class="back-to-top-link mobile-only">
      {backToTopText}
      <div class="arrow-up">
        <Fragment set:html={WhiteUpArrow} />
      </div>
    </a>
    <small>
      © {currentYear} Biombo Studio -
      <a href={legalLinkUrl} class="legal-link">
        {legalLinkText}
      </a>
    </small>
  </div>

  <script>
    // Find all back-to-top links and the horizontal scrolling container from the main page
    const backToTopLinks = document.querySelectorAll('.back-to-top-link')
    const horizontalContainer = document.getElementById('horizontal-container')

    // Add listener to all back-to-top links
    backToTopLinks.forEach((link) => {
      link.addEventListener('click', (event) => {
        // 1. Stop the link from its default "jump" behavior
        event.preventDefault()

        // 2. Instantly reset the horizontal container to the beginning if it exists
        if (horizontalContainer) {
          horizontalContainer.scrollLeft = 0
        }

        // 3. Smoothly scroll the main page to the very top
        window.scrollTo({
          top: 0,
          behavior: 'smooth',
        })
      })
    })
  </script>
</footer>

<style>
  /* --- Your Existing Footer Styles --- */
  footer {
    --padding-block-footer: clamp(5rem, 4.023rem + 4.007vi, 7.813rem);
    background-color: var(--color-secondary, #f0f0f0);
    color: var(--color-primary, #111);
    padding-block-start: var(--padding-block-footer);
    padding-block-end: clamp(3.125rem, 2.604rem + 2.137vi, 4.625rem);
    padding-inline: var(--padding-inline, 2rem);
  }

  .picket-fence {
    mask: conic-gradient(from 117.5deg at top, #0000, #000 0.5deg 124.5deg, #0000 125deg) 50%/46.1px
      100%;
    -webkit-mask: conic-gradient(from 117.5deg at top, #0000, #000 0.5deg 124.5deg, #0000 125deg)
      50%/46.1px 100%;
    mask-size: 46.1px 100%;
    -webkit-mask-size: 46.1px 100%;
    mask-repeat: repeat-x;
    -webkit-mask-repeat: repeat-x;
  }

  .footer-first-row {
    display: flex;
    justify-content: space-between;
    padding-block-end: var(--padding-block-footer);
  }

  .back-to-top-link {
    align-self: end;
    display: flex;
    gap: 1rem;
  }

  /* Desktop/Mobile visibility */
  .desktop-only {
    display: flex;
  }

  .mobile-only {
    display: none;
  }

  .arrow-up {
    transform: translate(0);
    transition: transform 0.2s ease-in-out;
  }

  .back-to-top-link:hover .arrow-up {
    transform: translateY(-0.2rem);
  }

  .footer-slogan {
    font-size: clamp(3rem, 2.305rem + 2.85vi, 5rem);
    letter-spacing: -0.04em;
    font-weight: var(--font-weight-regular);
    line-height: 1.03;
    max-width: 55%;
  }

  .contact-info,
  address,
  .social-links {
    display: flex;
    gap: 1.4375rem;
    align-items: baseline;
  }

  .footer-second-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  address {
    font-style: normal;
  }

  .social-links {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: clamp(1.25rem, 0.726rem + 0.818vi, 1.5rem);
  }

  /* The <small> tag is reverted to its original, non-flex state */
  small {
    font-size: clamp(0.875rem, 0.351rem + 0.818vi, 1.125rem);
    height: 36.0461px;
    transform: translate(0px, -7.24921px);
  }

  /* --- Styles for the Animation Effect --- */
  .label-wrapper {
    display: inline-block;
    overflow: hidden;
    position: relative;
    height: 1.4em;
    vertical-align: baseline; /* Kept as a good default */
  }

  .label-main,
  .label-hover {
    display: block;
    transition: transform 0.4s cubic-bezier(0.2, 1, 0.3, 1);
  }

  .label-hover {
    position: absolute;
    top: 0;
    left: 0;
    transform: translateY(100%);
  }

  a:hover .label-main,
  a:focus-within .label-main {
    transform: translateY(-100%);
  }

  a:hover .label-hover,
  a:focus-within .label-hover {
    transform: translateY(0);
  }

  .underline {
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }

  .legal-link {
    position: relative;
    text-decoration: none;

    /* Animated underline */
    &::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 1px;
      background-color: currentColor;
      transition: width 0.3s ease;
    }

    &:hover::after,
    &:focus-within::after {
      width: 100%;
    }
  }

  /* --- Targeted Fix for "Avís Legal" Link --- */
  /* This new rule applies the manual offset ONLY to the link inside the <small> tag. */
  small .label-wrapper {
    /* You can adjust this value (e.g., -0.2em, -0.3em) for pixel-perfect alignment. */
    vertical-align: -0.25em;
  }

  .highlight-wrapper {
    position: relative;
    display: inline-block;
  }

  @media (width < 992px) {
    .footer-first-row {
      display: block;
      padding-block-end: 4rem;
    }
    .footer-slogan {
      max-width: 100%;
    }

    .footer-second-row {
      flex-direction: column;
      gap: 0rem;
    }

    .contact-info,
    address,
    .social-links {
      flex-direction: column;
      gap: 0rem;
    }

    /* Hide desktop version, show mobile version */
    .desktop-only {
      display: none;
    }

    .mobile-only {
      display: flex;
      align-self: start;
      padding-block: 2.375rem;
    }
  }
</style>
