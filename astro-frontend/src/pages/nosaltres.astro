---
import BaseLayout from '@/layouts/BaseLayout.astro'
import TwoColumnLayout from '@/components/shared/TwoColumnLayout.astro'
import AboutSlider from '@/components/shared/AboutSlider.astro'
import ClientLogosSlider from '@/components/shared/ClientLogosSlider.astro'
import { fetchAboutUsPageByLocale } from '@/shared/lib/sanity/queries/aboutUsPageQueries'
import type { AboutUsPage } from '@/shared/schemas/sanity/aboutUsPageSchema'
import { toHTML, type PortableTextComponents } from '@portabletext/to-html'
import type { PortableTextBlock } from '@portabletext/types'
import type { DisplayImage } from '@/components/shared/AboutSlider.astro'

// This is the Catalan about us page
const locale = 'ca'

// Fetch about us page data from Sanity
let aboutUsPageData: AboutUsPage | null = null

try {
  aboutUsPageData = await fetchAboutUsPageByLocale(locale)
  console.log('About Us Page Data:', aboutUsPageData)
  console.log('Clients Title:', aboutUsPageData?.clientsTitle)
} catch (error) {
  console.error('Error fetching about us page data:', error)
}

// Convert Portable Text to HTML
function portableTextToHtml(description: PortableTextBlock[] | undefined): string {
  if (!description || description.length === 0) return ''

  const customPortableTextComponents: Partial<PortableTextComponents> = {
    block: {
      normal({ children }): string {
        return `${children || ''}<br /><br />`
      },
    },
  }

  return toHTML(description as any, {
    components: customPortableTextComponents,
  }).replace(/<br \/><br \/>$/, '') // Remove trailing line breaks
}

const descriptionHtml = portableTextToHtml(aboutUsPageData?.description)

// Transform images to the expected format for AboutSlider
const sliderImages: DisplayImage[] = aboutUsPageData?.aboutSlider?.images
  ? aboutUsPageData.aboutSlider.images.map((img) => ({
      ...img,
      asset: img.asset,
    }))
  : []
---

<BaseLayout
  title="Nosaltres - Biombo Studio"
  metaDescription={aboutUsPageData?.description?.[0]?.children?.[0]?.text}
>
  <main>
    {
      aboutUsPageData && (
        <Fragment>
          <TwoColumnLayout>
            <h1 slot="first-column">{aboutUsPageData.title}</h1>
            <div slot="second-column">{descriptionHtml && <p set:html={descriptionHtml} />}</div>
          </TwoColumnLayout>
        </Fragment>
      )
    }
  </main>

  {
    aboutUsPageData?.aboutSlider && (
      <AboutSlider
        title={aboutUsPageData.aboutSlider.title}
        description={aboutUsPageData.aboutSlider.description}
        images={sliderImages}
      />
    )
  }

  {
    aboutUsPageData?.clientsTitle && (
      <section class="clients-section">
        <h2>{aboutUsPageData.clientsTitle}</h2>
        <ClientLogosSlider speed="normal" pauseOnHover={true} />
      </section>
    )
  }
</BaseLayout>

<style>
  main {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    font-size: clamp(3rem, 2.305rem + 2.85vi, 5rem);
    letter-spacing: -0.04em;
    font-weight: var(--font-weight-semibold);
    /* line-height: 1; */
  }

  p {
    font-size: clamp(1.125rem, 0.691rem + 1.781vi, 2.375rem);
    line-height: 1.2;
    padding-block-start: 1.2rem;
    letter-spacing: -0.04em;
    margin-block-end: 0px !important;
  }

  .about-slider-section {
    margin-block-start: 4rem;
  }

  .clients-section {
    padding-block: clamp(4.375rem, 2.639rem + 7.124vi, 9.375rem);
    padding-inline: var(--padding-inline);
    /* line-height: 0; */
  }

  .clients-section h2 {
    font-size: clamp(2rem, 1.435rem + 2.318vi, 3.625rem);
    letter-spacing: -0.04em;
    font-weight: var(--font-weight-semibold);
    /* margin-block-end: clamp(2rem, 1.134rem + 3.553vi, 4.5rem); */
  }

  @media (width < 992px) {
    p {
      padding-block-start: 0rem;
    }
  }

  /* .clients-slider-wrapper {
    margin-block-start: 2rem;
  } */
</style>
